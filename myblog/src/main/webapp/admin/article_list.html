<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>文章管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta content="Coderthemes" name="author"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <link rel="shortcut icon" href="../static/image/logo.png"/>
    <link href="../vendor/bootstrap/css/bootstrap.css" rel="stylesheet" type="text/css"/>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="../vendor/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.4.1/sweetalert2.min.css" rel="stylesheet"/>

    <style>
        .label {
            margin-left: 10px;
        }

        .table tbody tr td {
            vertical-align: middle;
        }
    </style>
</head>
<body class="fixed-left">
<div id="wrapper">
    <!--头部和左边菜单-->
    <div>
        <div class="topbar">
            <div class="topbar-left">
                <div class="text-center p-t-10" style="margin: 0 auto;">
                    <div class="pull-left" style="padding-left: 10px;">
                        <a href="/admin/index.html">
                            <img src="../static/image/logo.png" width="50" height="50"/>
                        </a>
                    </div>
                    <div class="pull-left" style="padding-left: 10px;">
                        <span style="font-size: 20px; color: #2f353f; line-height: 50px;">我的博客</span>
                    </div>
                </div>
            </div>
            <div class="navbar navbar-default" role="navigation">
                <div class="container">
                    <div class="">
                        <div class="pull-left">
                            <button type="button" class="button-menu-mobile open-left">
                                <i class="fa fa-bars"></i>
                            </button>
                            <span class="clearfix"></span>
                        </div>

                        <ul class="nav navbar-nav navbar-right pull-right">
                            <li class="dropdown">
                                <a href="/admin/index.html" class="dropdown-toggle profile" data-toggle="dropdown"
                                   aria-expanded="true">
                                    <span class="glyphicon glyphicon-user"/>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a href="javascript:void(0);" onclick="logout()"><i class="fa fa-sign-out"></i>
                                        注销</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="left side-menu">
            <div class="sidebar-inner slimscrollleft">
                <div id="sidebar-menu">
                    <ul>
                        <li>
                            <a id="index" href="index.html" class="waves-effect ">
                                <i class="fa fa-dashboard" aria-hidden="true"></i>
                                <span> 仪表盘 </span>
                            </a>
                        </li>
                        <li>
                            <a id="article_edit" href="article_edit.html?type=newArticle" class="waves-effect">
                                <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                                <span> 发布文章 </span>
                            </a>
                        </li>
                        <li>
                            <a href="article_list.html" class="waves-effect active">
                                <i class="fa fa-list" aria-hidden="true"></i>
                                <span> 文章管理 </span>
                            </a>
                        </li>
                        <li>
                            <a href="comment_list.html" class="waves-effect">
                                <i class="fa fa-comments" aria-hidden="true"></i>
                                <span> 评论管理 </span>
                            </a>
                        </li>
                        <li>
                            <a href="category.html" class="waves-effect">
                                <i class="fa fa-tags" aria-hidden="true"></i>
                                <span> 分类/标签 </span>
                            </a>
                        </li>
                        <li>
                            <a href="file.html" class="waves-effect">
                                <i class="fa fa-cloud-upload" aria-hidden="true"></i>
                                <span> 文件管理 </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="content-page">
        <div class="content">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>文章标题</th>
                                <th>发布时间</th>
                                <th>浏览量</th>
                                <th>所属分类</th>
                                <th>发布状态</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="tb_article">
                            <tr>
                                <td>1</td>
                                <td>Spring入门指南</td>
                                <td>2019年4月22日11:29:39</td>
                                <td>48</td>
                                <td>
                                    <button class="btn btn-primary">所属分类</button>
                                </td>
                                <td>已发布</td>
                                <td>
                                    <button class="btn btn-primary btn-sm waves-effect waves-light m-b-5">编辑</button>
                                    <button class="btn btn-danger btn-sm waves-effect waves-light m-b-5">编辑</button>
                                    <button class="btn btn-warning btn-sm waves-effect waves-light m-b-5">预览</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <nav class="pull-right">
                            <ul class="pagination" id="paging_toolbar">
                                <li><a href="#" aria-label="Previous"><span aria-hidden="true">上一页</span></a></li>
                                <li class="active"><a href="#">1<span class="sr-only">(current)</span></a></li>
                                <li class=""><a href="#">2<span class="sr-only">(current)</span></a></li>
                                <li class=""><a href="#">3<span class="sr-only">(current)</span></a></li>
                                <li class=""><a href="#">4<span class="sr-only">(current)</span></a></li>
                                <li class=""><a href="#">5<span class="sr-only">(current)</span></a></li>
                                <li class="disabled"><a href="#" aria-label="Previous"><span
                                        aria-hidden="true">下一页</span></a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div>
                    <footer class="footer text-right">
                        2019 © <a href="#" target="_blank">Blog</a>
                        <div class=""></div>
                    </footer>
                </div>
            </div>
            <div class="modal fade" id="category_list" tabindex="-1" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">文章所属分类</h4>
                        </div>
                        <div class="modal-body" id="">
                            <span class="label label-success">分类1</span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--所有页面必须导入start-->
<script src="https://cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script>
<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.4.1/sweetalert2.min.js"></script>
<script src="../vendor/jquery.app.js"></script>
<script src="../vendor/base.js"></script>
<!--所有页面必须导入end-->
<script type="text/javascript">
    var tale = new $.tale();
    $(function () {
        loadPage(1);
    });

    /**
     * 加载分页数据
     * @param currentPage 当前分页
     */
    function loadPage(currentPage) {
        $.get('article/getAllArticle.action', "currentPage=" + currentPage, function (result) {
            if (result.code === 200) {
                //没有数据
                if (result.data == null) {
                    $("#tb_article").html("<tr><td class='text-center' colspan=\"7\">没有数据</td></tr>");
                    return;
                }

                // 表格列表
                var tbTxt = "";
                for (var i = 0; i < result.data.list.length; i++) {
                    var article = result.data.list[i];
                    var div = "<tr>\n" +
                        "                                    <td>" + article.id + "</td>" +
                        "                                    <td>" + article.title + "</td>" +
                        "                                    <td>" + new Date(article.created * 1000).toLocaleString() + "</td>" +
                        "                                    <td>" + article.hits + "</td>" +
                        "                                    <td ><button class='btn btn-sm btn-primary' onclick='showCategoryModel(" + article.id + ")'>所属分类</button></td>";

                    //文章状态
                    if (article.status === 'publish') {
                        div += "<td><span class='label label-success'>已发布</span></td>";
                    } else {
                        div += "<td><span class='label label-default'>草稿</span></td>";
                    }
                    div +=
                        "                                    <td>" +
                        "                                        <button class='btn btn-primary btn-sm waves-effect waves-light m-b-5' onclick='editArticle(" + article.id + ")'>编辑</button>" +
                        "                                        <button class='btn btn-danger btn-sm waves-effect waves-light m-b-5' onclick='deleteArticle(" + article.id + "," + currentPage + ")'>删除</button>" +
                        "                                        <button class='btn btn-warning btn-sm waves-effect waves-light m-b-5' onclick='preview(" + article.id + ")'>预览</button>" +
                        "                                    </td>" +
                        "                                </tr>";
                    tbTxt += div;
                }
                $("#tb_article").html(tbTxt);

                //分页条
                var $paging_toolbar = $("#paging_toolbar");
                var paging_toolbarTxt = "<li class='disabled'><a href='#'>第" + result.data.currentPage + "页 / 共" + result.data.pageCount + "页</a></li>";

                //如果当前是第一页，那么【上一页】按钮不可点击
                if (currentPage === 1) {
                    paging_toolbarTxt += "<li class='disabled'><a href='#'>上一页</a></li>";
                } else {
                    paging_toolbarTxt += "<li onclick='loadPage(" + (currentPage - 1) + ")'><a href='#'>上一页</a></li>";
                }
                //遍历生成页码
                for (var i = result.data.pageBeginIndex; i <= result.data.pageEndIndex; i++) {
                    if (result.data.currentPage === i) {
                        paging_toolbarTxt += "<li onclick='loadPage(" + i + ")' class='active'><a href='#'>" + i + "</a></li>";
                    } else {
                        paging_toolbarTxt += "<li onclick='loadPage(" + i + ")' ><a href='#'>" + i + "</a></li>";
                    }
                }
                //如果当前是最后一页，那么【下一页】按钮不可点击
                if (currentPage === result.data.pageCount) {
                    paging_toolbarTxt += "<li class='disabled'><a href='#'>下一页</a></li>";
                } else {
                    paging_toolbarTxt += "<li onclick='loadPage(" + (currentPage + 1) + ")'><a href='#'>下一页</a></li>";
                }
                $paging_toolbar.html(paging_toolbarTxt);
            } else if (result.code === 403) {
                show403();
            } else {
                tale.alertError(result.msg);
            }
        }, 'json');
    }


    /**
     * 删除指定文章
     * @param aid 文章id
     * @param currentPage 当前页码
     */
    function deleteArticle(aid, currentPage) {
        tale.alertConfirm({
            title: '确定删除该文章吗?',
            then: function () {
                $.post('article/deleteById.action', "aid=" + aid, function (result) {
                    if (result.code === 200) {
                        //删除后直接刷新页面
                        loadPage(currentPage);
                    } else if (result.code === 403) {
                        show403();
                    } else {
                        tale.alertError(result.msg);
                    }
                }, "json");
            }
        });
    }

    /**
     * 显示所属分类模态框
     * @param aid 文章id
     */
    function showCategoryModel(aid) {
        $.get("category/getCategoryByArticleId.action", "aid=" + aid, function (result) {
            if (result.code === 200) {
                var spanTxt = "";
                if (result.data.length > 0) {
                    for (var i = 0; i < result.data.length; i++) {
                        var category = result.data[i];
                        spanTxt += "<span class='label label-success'>" + category.name + "</span>";
                    }
                    $("#category_list .modal-body").html(spanTxt);
                } else {
                    $("#category_list .modal-body").html("<span>该文章没有分类</span>");
                }
                $("#category_list").modal("show");
            } else if (result.code === 403) {
                show403();
            } else {
                tale.alertError(result.msg);
            }
        }, "json");
    }

    /**
     * 跳转编辑文章页面
     * @param aid 文章id
     */
    function editArticle(aid) {
        location.href = "article_edit.html?aid=" + aid;
    }

    /**
     * 跳转文章预览页面
     * @param aid 文章id
     */
    function preview(aid) {
        location.href = getRootPath() + "/post.html?aid=" + aid;
    }


</script>
</body>
</html>